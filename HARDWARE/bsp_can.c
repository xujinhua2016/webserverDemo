/*
*********************************************************************************************************
*
*                                        BOARD SUPPORT PACKAGE
*
*                                     ST Microelectronics STM32
*                                              on the
*
*                                              Fendou
*                                        Evaluation Board
*
* Filename      : bsp_can.c
* Version       : V1.00
* Programmer(s) : WEN
*********************************************************************************************************
*/

/*
*********************************************************************************************************
*                                             INCLUDE FILES
*********************************************************************************************************
*/

#include  "bsp_can.h" 

CanTxMsg TxMessage;
CanRxMsg RxMessage;

__IO  uint8_t  BSP_CAN_Rx_Flag = 1;


static void CAN_GPIO_Config(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	/*外设时钟设置*/
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA, ENABLE);//使能PORTA时钟	                   											 
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_CAN1, ENABLE);//使能CAN1时钟	
	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11| GPIO_Pin_12;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;//复用功能
  GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//推挽输出
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;//100MHz
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;//上拉
  GPIO_Init(GPIOA, &GPIO_InitStructure);//初始化PA11,PA12
	
	//引脚复用映射配置
	GPIO_PinAFConfig(GPIOA,GPIO_PinSource11,GPIO_AF_CAN1); //GPIOA11复用为CAN1
	GPIO_PinAFConfig(GPIOA,GPIO_PinSource12,GPIO_AF_CAN1); //GPIOA12复用为CAN1
}

static void CAN_NVIC_Config(void)
{
  NVIC_InitTypeDef NVIC_InitStructure;
	
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_0);
	
	NVIC_InitStructure.NVIC_IRQChannel = CAN1_RX0_IRQn;
  NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;  //抢占优先级0
  NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;			   //子优先级为0
  NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
  NVIC_Init(&NVIC_InitStructure);
}


static void CAN_Mode_Config(void)
{
  CAN_InitTypeDef CAN_InitStructure;
	/************************CAN通信参数设置**********************************/
	/*CAN寄存器初始化*/
	CAN_DeInit(CAN1);
	CAN_StructInit(&CAN_InitStructure);
	/*CAN单元初始化*/
	CAN_InitStructure.CAN_TTCM=DISABLE;			       //MCR-TTCM  时间触发通信模式使能
  CAN_InitStructure.CAN_ABOM=ENABLE;			       //MCR-ABOM  自动离线管理 
  CAN_InitStructure.CAN_AWUM=ENABLE;			       //MCR-AWUM  自动唤醒模式
  CAN_InitStructure.CAN_NART=DISABLE;			       //MCR-NART  禁止报文自动重传	  DISABLE-自动重传
  CAN_InitStructure.CAN_RFLM=DISABLE;			       //MCR-RFLM  接收FIFO 锁定模式  DISABLE-溢出时新报文会覆盖原有报文  
  CAN_InitStructure.CAN_TXFP=DISABLE;			       //MCR-TXFP  发送FIFO优先级 DISABLE-优先级取决于报文标示符 
  CAN_InitStructure.CAN_Mode = CAN_Mode_Normal;  //正常发送模式
  CAN_InitStructure.CAN_SJW=CAN_SJW_1tq;			   //BTR-SJW 重新同步跳跃宽度 2个时间单元
  CAN_InitStructure.CAN_BS1=CAN_BS1_3tq;			   //BTR-TS1 时间段1 占用了6个时间单元
  CAN_InitStructure.CAN_BS2=CAN_BS2_2tq;			   //BTR-TS1 时间段2 占用了3个时间单元
  CAN_InitStructure.CAN_Prescaler =14;			     //BTR-BRP 波特率分频器  定义了时间单元的时间长度 36/(1+6+3)/4=0.8Mbps
	CAN_Init(CAN1, &CAN_InitStructure);
}

static void CAN_Filter_Config(void)
{
	CAN_FilterInitTypeDef CAN_FilterInitStructure;

	/*CAN过滤器初始化*/
	CAN_FilterInitStructure.CAN_FilterNumber=0;										//过滤器组0
  CAN_FilterInitStructure.CAN_FilterMode=CAN_FilterMode_IdMask;	//工作在标识符屏蔽位模式
	CAN_FilterInitStructure.CAN_FilterScale=CAN_FilterScale_32bit;	//过滤器位宽为单个32位。
	/* 使能报文标示符过滤器按照标示符的内容进行比对过滤，扩展ID不是如下的就抛弃掉，是的话，会存入FIFO0。 */

  CAN_FilterInitStructure.CAN_FilterIdHigh= (((u32)0x5000<<3)&0xFFFF0000)>>16;				//要过滤的ID高位 
  CAN_FilterInitStructure.CAN_FilterIdLow= (((u32)0x5000<<3)|CAN_ID_EXT|CAN_RTR_DATA)&0xFFFF; //要过滤的ID低位 
  CAN_FilterInitStructure.CAN_FilterMaskIdHigh= 0xFFFF;			//过滤器高16位每位必须匹配
  CAN_FilterInitStructure.CAN_FilterMaskIdLow= 0xFFFF;			//过滤器低16位每位必须匹配
	CAN_FilterInitStructure.CAN_FilterFIFOAssignment=CAN_FilterFIFO0;				//过滤器被关联到FIFO0
	CAN_FilterInitStructure.CAN_FilterActivation=ENABLE;			//使能过滤器
	CAN_FilterInit(&CAN_FilterInitStructure);
	/*CAN通信中断使能*/
	CAN_ITConfig(CAN1, CAN_IT_FMP0, ENABLE);
}


void BSP_CAN_Init(void)
{
	CAN_GPIO_Config();
  CAN_NVIC_Config();
  CAN_Mode_Config();
  CAN_Filter_Config(); 
}


void BSP_CAN_SetTxMsg(uint32_t ID, uint8_t cmd)
{
  TxMessage.ExtId   = ID;
  TxMessage.IDE     = CAN_ID_EXT;
  TxMessage.RTR     = CAN_RTR_DATA;
  TxMessage.DLC     = 1;
  TxMessage.Data[0] = cmd;
	
	CAN_Transmit(CAN1, &TxMessage);	
}
